<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Temperature Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a2e; /* Dark background similar to screenshot */
            color: #e0e0e0;
        }
        .visualization-container {
            display: grid;
            /* Updated: Years as columns, Months as rows */
            /* grid-template-columns will be set dynamically by JS */
            grid-template-rows: repeat(12, 1fr); /* 12 rows for months */
            width: 800px; /* Adjust as needed */
            height: 400px; /* Adjust as needed */
            border: 1px solid #333;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .temp-bar {
            width: 100%;
            height: 100%;
            /* Each bar will be colored by JS */
        }
        .description {
            width: 800px;
            text-align: center;
            font-size: 1.1em;
            line-height: 1.5;
            color: #b0b0b0;
        }
        .description strong {
            color: #ffffff;
        }
        .mode-toggle-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .mode-toggle-bar button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .mode-toggle-bar button:hover {
            background-color: #555;
        }
        .mode-toggle-bar button.active {
            background-color: #007bff;
            border-color: #007bff;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="mode-toggle-bar">
        <button id="temperature-mode-btn" class="active">Temperature Mode</button>
        <button id="anomaly-mode-btn">Anomaly Mode</button>
    </div>
    <div class="visualization-container" id="temp-visualization"></div>
    <p class="description" id="description-text"></p>

    <script>
        const DATA_FILE_PATH = 'global-temperatures/1850-2024-Months.csv';
        const BASELINE_FILE_PATH = 'global-temperatures/baseline-1991-2020.json';
        let monthlyBaselineTemps = new Map(); // Map to store monthly baseline temperatures (month number -> temp in C)
        let annualOverallBaselineTempC; // Annual average baseline for description

        function celsiusToFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }

        async function loadTemperatureData() {
            try {
                const [csvResponse, baselineResponse] = await Promise.all([
                    fetch(DATA_FILE_PATH),
                    fetch(BASELINE_FILE_PATH)
                ]);

                const csvText = await csvResponse.text();
                const baselineData = await baselineResponse.json();

                // Populate monthlyBaselineTemps map
                baselineData.monthlyAverages.forEach((avg, index) => {
                    // Month index is 0-based in array, but 1-based for actual month number
                    monthlyBaselineTemps.set(index + 1, avg.landAndOceanC);
                });
                annualOverallBaselineTempC = baselineData.annualAverage.landAndOceanC;

                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('temp-visualization').textContent = 'Failed to load data.';
                return [];
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            // Skip header lines (lines starting with #) and the column header line
            const dataLines = lines.filter(line => !line.startsWith('#') && line.includes(','));
            
            const parsedData = [];
            for (const line of dataLines) {
                const [dateStr, anomalyStr] = line.split(',');
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6));
                const anomaly = parseFloat(anomalyStr);

                if (!isNaN(year) && !isNaN(month) && !isNaN(anomaly)) {
                    parsedData.push({ year, month, anomaly });
                }
            }
            return parsedData;
        }

        // Function to convert hex color to RGB
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }

        // Define the three hex colors
        const COLOR_COLD = '#0000FF'; // Blue
        const COLOR_MID = '#FFFFFF';  // Middle
        const COLOR_HOT = '#FF0000';  // Red

        function getColorForValue(value, minVal, maxVal) {
            const normalizedValue = (value - minVal) / (maxVal - minVal);

            const colorColdRgb = hexToRgb(COLOR_COLD);
            const colorMidRgb = hexToRgb(COLOR_MID);
            const colorHotRgb = hexToRgb(COLOR_HOT);

            let r, g, b;

            if (normalizedValue < 0.5) {
                // Transition from COLOR_COLD to COLOR_MID
                const t = normalizedValue * 2; // Scale to 0-1 for this segment
                r = Math.round(colorColdRgb.r + (colorMidRgb.r - colorColdRgb.r) * t);
                g = Math.round(colorColdRgb.g + (colorMidRgb.g - colorColdRgb.g) * t);
                b = Math.round(colorColdRgb.b + (colorMidRgb.b - colorColdRgb.b) * t);
            } else {
                // Transition from COLOR_MID to COLOR_HOT
                const t = (normalizedValue - 0.5) * 2; // Scale to 0-1 for this segment
                r = Math.round(colorMidRgb.r + (colorHotRgb.r - colorMidRgb.r) * t);
                g = Math.round(colorMidRgb.g + (colorHotRgb.g - colorMidRgb.g) * t);
                b = Math.round(colorMidRgb.b + (colorHotRgb.b - colorMidRgb.b) * t);
            }
            return `rgb(${r}, ${g}, ${b})`;
        }

        let currentMode = 'anomaly'; // 'temperature' or 'anomaly'
        let allData = []; // Store parsed data globally

        async function renderVisualization(mode) {
            currentMode = mode;
            const visualizationContainer = document.getElementById('temp-visualization');
            visualizationContainer.innerHTML = ''; // Clear previous visualization

            if (allData.length === 0) {
                allData = await loadTemperatureData();
                if (allData.length === 0) {
                    visualizationContainer.textContent = 'Failed to load temperature data.';
                    return;
                }
            }

            const dataToVisualize = currentMode === 'temperature'
                ? allData.map(d => d.anomaly + monthlyBaselineTemps.get(d.month))
                : allData.map(d => d.anomaly);

            const minVal = Math.min(...dataToVisualize);
            const maxVal = Math.max(...dataToVisualize);

            const startYear = allData[0].year;
            const endYear = allData[allData.length - 1].year;
            const numYears = endYear - startYear + 1;

            visualizationContainer.style.gridTemplateColumns = `repeat(${numYears}, 1fr)`;

            const monthlyDataMap = new Map();
            allData.forEach(d => {
                if (!monthlyDataMap.has(d.year)) {
                    monthlyDataMap.set(d.year, new Map());
                }
                monthlyDataMap.get(d.year).set(d.month, d); // Store full data object
            });

            for (let month = 1; month <= 12; month++) {
                for (let year = startYear; year <= endYear; year++) {
                    const tempBar = document.createElement('div');
                    tempBar.classList.add('temp-bar');
                    
                    const monthData = monthlyDataMap.has(year) && monthlyDataMap.get(year).has(month)
                        ? monthlyDataMap.get(year).get(month)
                        : null;

                    if (monthData !== null) {
                        let value;
                        let titleText;
                        if (currentMode === 'temperature') {
                            value = monthData.anomaly + monthlyBaselineTemps.get(monthData.month);
                            titleText = `Absolute: ${value.toFixed(2)}°C`;
                        } else { // anomaly mode
                            value = monthData.anomaly;
                            titleText = `Anomaly: ${value.toFixed(2)}°C`;
                        }
                        tempBar.style.backgroundColor = getColorForValue(value, minVal, maxVal);
                        tempBar.title = `Year: ${year}, Month: ${month}, ${titleText}`;
                    } else {
                        tempBar.style.backgroundColor = '#333'; 
                        tempBar.title = `Year: ${year}, Month: ${month}, Data Missing`;
                    }
                    
                    visualizationContainer.appendChild(tempBar);
                }
            }

            const descriptionElement = document.getElementById('description-text');
            if (currentMode === 'temperature') {
                const annualTemperatures = {};
                allData.forEach(d => {
                    if (!annualTemperatures[d.year]) {
                        annualTemperatures[d.year] = [];
                    }
                    annualTemperatures[d.year].push(d.anomaly + monthlyBaselineTemps.get(d.month));
                });

                const annualAverages = Object.values(annualTemperatures).map(temps => {
                    const sum = temps.reduce((acc, curr) => acc + curr, 0);
                    return sum / temps.length;
                });

                const minAnnualAvgC = Math.min(...annualAverages);
                const maxAnnualAvgC = Math.max(...annualAverages);
                const minAnnualAvgF = celsiusToFahrenheit(minAnnualAvgC);
                const maxAnnualAvgF = celsiusToFahrenheit(maxAnnualAvgC);

                descriptionElement.innerHTML = `
                    This visualization shows global monthly temperature from January ${startYear} to December ${endYear}. Annual average
                    temperatures range from <strong>${minAnnualAvgC.toFixed(1)}°C (${minAnnualAvgF.toFixed(1)}°F)</strong> to <strong>${maxAnnualAvgC.toFixed(1)}°C (${maxAnnualAvgF.toFixed(1)}°F)</strong>.
                `;
            } else { // anomaly mode
                const minAnomaly = Math.min(...allData.map(d => d.anomaly));
                const maxAnomaly = Math.max(...allData.map(d => d.anomaly));
                descriptionElement.innerHTML = `
                    This visualization shows global monthly temperature anomalies from January ${startYear} to December ${endYear}. Anomalies
                    range from <strong>${minAnomaly.toFixed(2)}°C</strong> to <strong>${maxAnomaly.toFixed(2)}°C</strong> relative to the 1991-2020 baseline.
                `;
            }

            // Update button active states
            document.getElementById('temperature-mode-btn').classList.toggle('active', currentMode === 'temperature');
            document.getElementById('anomaly-mode-btn').classList.toggle('active', currentMode === 'anomaly');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('temperature-mode-btn').addEventListener('click', () => renderVisualization('temperature'));
            document.getElementById('anomaly-mode-btn').addEventListener('click', () => renderVisualization('anomaly'));
            renderVisualization('anomaly'); // Initial render
        });
    </script>
</body>
</html>
