<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Temperature Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a2e; /* Dark background similar to screenshot */
            color: #e0e0e0;
        }
        .visualization-container {
            display: grid;
            /* Updated: Years as columns, Months as rows */
            /* grid-template-columns will be set dynamically by JS */
            grid-template-rows: repeat(12, 1fr); /* 12 rows for months */
            width: 800px; /* Adjust as needed */
            height: 400px; /* Adjust as needed */
            border: 1px solid #333;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .temp-bar {
            width: 100%;
            height: 100%;
            /* Each bar will be colored by JS */
        }
        .description {
            width: 800px;
            text-align: center;
            font-size: 1.1em;
            line-height: 1.5;
            color: #b0b0b0;
        }
        .description strong {
            color: #ffffff;
        }
        .mode-toggle-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .mode-toggle-bar button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .mode-toggle-bar button:hover {
            background-color: #555;
        }
        .mode-toggle-bar button.active {
            background-color: #007bff;
            border-color: #007bff;
            color: #ffffff;
        }

        .color-picker-container {
            display: flex;
            gap: 40px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #2a2a4a;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .color-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .color-picker label {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            width: 200px;
        }

        .slider-group label {
            font-size: 0.9em;
            font-weight: normal;
            margin-bottom: 2px;
        }

        .slider-group input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #555;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .hex-display {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="color-picker-container">
        <div class="color-picker">
            <label>Cold Color</label>
            <div class="slider-group">
                <label for="cold-hue">Hue:</label>
                <input type="range" id="cold-hue" min="0" max="360" value="240">
            </div>
            <div class="slider-group">
                <label for="cold-saturation">Saturation:</label>
                <input type="range" id="cold-saturation" min="0" max="100" value="100">
            </div>
            <div class="slider-group">
                <label for="cold-value">Value:</label>
                <input type="range" id="cold-value" min="0" max="100" value="100">
            </div>
            <div id="cold-hex-display" class="hex-display">#0000FF</div>
        </div>

        <div class="color-picker">
            <label>Hot Color</label>
            <div class="slider-group">
                <label for="hot-hue">Hue:</label>
                <input type="range" id="hot-hue" min="0" max="360" value="0">
            </div>
            <div class="slider-group">
                <label for="hot-saturation">Saturation:</label>
                <input type="range" id="hot-saturation" min="0" max="100" value="100">
            </div>
            <div class="slider-group">
                <label for="hot-value">Value:</label>
                <input type="range" id="hot-value" min="0" max="100" value="100">
            </div>
            <div id="hot-hex-display" class="hex-display">#FF0000</div>
        </div>
    </div>

    <div class="mode-toggle-bar">
        <button id="temperature-mode-btn" class="active">Temperature Mode</button>
        <button id="anomaly-mode-btn">Anomaly Mode</button>
    </div>
    <div class="visualization-container" id="temp-visualization"></div>
    <p class="description" id="description-text"></p>

    <script>
        const DATA_FILE_PATH = 'global-temperatures/1850-2024-Months.csv';
        const BASELINE_FILE_PATH = 'global-temperatures/baseline-1991-2020.json';
        let monthlyBaselineTemps = new Map(); // Map to store monthly baseline temperatures (month number -> temp in C)
        let annualOverallBaselineTempC; // Annual average baseline for description

        function celsiusToFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }

        async function loadTemperatureData() {
            try {
                const [csvResponse, baselineResponse] = await Promise.all([
                    fetch(DATA_FILE_PATH),
                    fetch(BASELINE_FILE_PATH)
                ]);

                const csvText = await csvResponse.text();
                const baselineData = await baselineResponse.json();

                // Populate monthlyBaselineTemps map
                baselineData.monthlyAverages.forEach((avg, index) => {
                    // Month index is 0-based in array, but 1-based for actual month number
                    monthlyBaselineTemps.set(index + 1, avg.landAndOceanC);
                });
                annualOverallBaselineTempC = baselineData.annualAverage.landAndOceanC;

                return parseCSV(csvText);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('temp-visualization').textContent = 'Failed to load data.';
                return [];
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            // Skip header lines (lines starting with #) and the column header line
            const dataLines = lines.filter(line => !line.startsWith('#') && line.includes(','));
            
            const parsedData = [];
            for (const line of dataLines) {
                const [dateStr, anomalyStr] = line.split(',');
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6));
                const anomaly = parseFloat(anomalyStr);

                if (!isNaN(year) && !isNaN(month) && !isNaN(anomaly)) {
                    parsedData.push({ year, month, anomaly });
                }
            }
            return parsedData;
        }

        // Function to convert hex color to RGB
        // Function to convert HSL to RGB
        function hslToRgb(h, s, l) {
            h /= 360;
            s /= 100;
            l /= 100;
            let r, g, b;

            if (s === 0) {
                r = g = b = l; // achromatic
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };

                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }

            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }

        // Function to convert RGB to Hex
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        // Initial color values from HTML
        let coldColor = {
            h: parseInt(document.getElementById('cold-hue').value),
            s: parseInt(document.getElementById('cold-saturation').value),
            v: parseInt(document.getElementById('cold-value').value)
        };
        let hotColor = {
            h: parseInt(document.getElementById('hot-hue').value),
            s: parseInt(document.getElementById('hot-saturation').value),
            v: parseInt(document.getElementById('hot-value').value)
        };

        // Function to convert HSV to HSL (since hslToRgb expects HSL)
        function hsvToHsl(h, s, v) {
            s /= 100;
            v /= 100;
            const l = (2 - s) * v / 2;
            const newS = l === 0 || l === 1 ? 0 : (s * v) / (l < 0.5 ? l * 2 : 2 - l * 2);
            return { h: h, s: newS * 100, l: l * 100 };
        }

        function getColorForValue(value, minVal, maxVal) {
            const normalizedValue = (value - minVal) / (maxVal - minVal);

            const coldHsl = hsvToHsl(coldColor.h, coldColor.s, coldColor.v);
            const hotHsl = hsvToHsl(hotColor.h, hotColor.s, hotColor.v);

            const colorColdRgb = hslToRgb(coldHsl.h, coldHsl.s, coldHsl.l);
            const colorMidRgb = { r: 255, g: 255, b: 255 }; // White middle color
            const colorHotRgb = hslToRgb(hotHsl.h, hotHsl.s, hotHsl.l);

            let r, g, b;

            if (normalizedValue < 0.5) {
                // Transition from COLOR_COLD to COLOR_MID
                const t = normalizedValue * 2; // Scale to 0-1 for this segment
                r = Math.round(colorColdRgb.r + (colorMidRgb.r - colorColdRgb.r) * t);
                g = Math.round(colorColdRgb.g + (colorMidRgb.g - colorColdRgb.g) * t);
                b = Math.round(colorColdRgb.b + (colorMidRgb.b - colorColdRgb.b) * t);
            } else {
                // Transition from COLOR_MID to COLOR_HOT
                const t = (normalizedValue - 0.5) * 2; // Scale to 0-1 for this segment
                r = Math.round(colorMidRgb.r + (colorHotRgb.r - colorMidRgb.r) * t);
                g = Math.round(colorMidRgb.g + (colorHotRgb.g - colorMidRgb.g) * t);
                b = Math.round(colorMidRgb.b + (colorHotRgb.b - colorMidRgb.b) * t);
            }
            return `rgb(${r}, ${g}, ${b})`;
        }

        let currentMode = 'anomaly'; // 'temperature' or 'anomaly'
        let allData = []; // Store parsed data globally

        async function renderVisualization(mode) {
            currentMode = mode;
            const visualizationContainer = document.getElementById('temp-visualization');
            visualizationContainer.innerHTML = ''; // Clear previous visualization

            if (allData.length === 0) {
                allData = await loadTemperatureData();
                if (allData.length === 0) {
                    visualizationContainer.textContent = 'Failed to load temperature data.';
                    return;
                }
            }

            const dataToVisualize = currentMode === 'temperature'
                ? allData.map(d => d.anomaly + monthlyBaselineTemps.get(d.month))
                : allData.map(d => d.anomaly);

            const minVal = Math.min(...dataToVisualize);
            const maxVal = Math.max(...dataToVisualize);

            const startYear = allData[0].year;
            const endYear = allData[allData.length - 1].year;
            const numYears = endYear - startYear + 1;

            visualizationContainer.style.gridTemplateColumns = `repeat(${numYears}, 1fr)`;

            const monthlyDataMap = new Map();
            allData.forEach(d => {
                if (!monthlyDataMap.has(d.year)) {
                    monthlyDataMap.set(d.year, new Map());
                }
                monthlyDataMap.get(d.year).set(d.month, d); // Store full data object
            });

            for (let month = 1; month <= 12; month++) {
                for (let year = startYear; year <= endYear; year++) {
                    const tempBar = document.createElement('div');
                    tempBar.classList.add('temp-bar');
                    
                    const monthData = monthlyDataMap.has(year) && monthlyDataMap.get(year).has(month)
                        ? monthlyDataMap.get(year).get(month)
                        : null;

                    if (monthData !== null) {
                        let value;
                        let titleText;
                        if (currentMode === 'temperature') {
                            value = monthData.anomaly + monthlyBaselineTemps.get(monthData.month);
                            titleText = `Absolute: ${value.toFixed(2)}°C`;
                        } else { // anomaly mode
                            value = monthData.anomaly;
                            titleText = `Anomaly: ${value.toFixed(2)}°C`;
                        }
                        tempBar.style.backgroundColor = getColorForValue(value, minVal, maxVal);
                        tempBar.title = `Year: ${year}, Month: ${month}, ${titleText}`;
                    } else {
                        tempBar.style.backgroundColor = '#333'; 
                        tempBar.title = `Year: ${year}, Month: ${month}, Data Missing`;
                    }
                    
                    visualizationContainer.appendChild(tempBar);
                }
            }

            const descriptionElement = document.getElementById('description-text');
            if (currentMode === 'temperature') {
                const annualTemperatures = {};
                allData.forEach(d => {
                    if (!annualTemperatures[d.year]) {
                        annualTemperatures[d.year] = [];
                    }
                    annualTemperatures[d.year].push(d.anomaly + monthlyBaselineTemps.get(d.month));
                });

                const annualAverages = Object.values(annualTemperatures).map(temps => {
                    const sum = temps.reduce((acc, curr) => acc + curr, 0);
                    return sum / temps.length;
                });

                const minAnnualAvgC = Math.min(...annualAverages);
                const maxAnnualAvgC = Math.max(...annualAverages);
                const minAnnualAvgF = celsiusToFahrenheit(minAnnualAvgC);
                const maxAnnualAvgF = celsiusToFahrenheit(maxAnnualAvgC);

                descriptionElement.innerHTML = `
                    This visualization shows global monthly temperature from January ${startYear} to December ${endYear}. Annual average
                    temperatures range from <strong>${minAnnualAvgC.toFixed(1)}°C (${minAnnualAvgF.toFixed(1)}°F)</strong> to <strong>${maxAnnualAvgC.toFixed(1)}°C (${maxAnnualAvgF.toFixed(1)}°F)</strong>.
                `;
            } else { // anomaly mode
                const minAnomaly = Math.min(...allData.map(d => d.anomaly));
                const maxAnomaly = Math.max(...allData.map(d => d.anomaly));
                descriptionElement.innerHTML = `
                    This visualization shows global monthly temperature anomalies from January ${startYear} to December ${endYear}. Anomalies
                    range from <strong>${minAnomaly.toFixed(2)}°C</strong> to <strong>${maxAnomaly.toFixed(2)}°C</strong> relative to the 1991-2020 baseline.
                `;
            }

            // Update button active states
            document.getElementById('temperature-mode-btn').classList.toggle('active', currentMode === 'temperature');
            document.getElementById('anomaly-mode-btn').classList.toggle('active', currentMode === 'anomaly');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('temperature-mode-btn').addEventListener('click', () => renderVisualization('temperature'));
            document.getElementById('anomaly-mode-btn').addEventListener('click', () => renderVisualization('anomaly'));

            // Helper function to update color and re-render
            function updateColor(colorType) {
                const hue = parseInt(document.getElementById(`${colorType}-hue`).value);
                const saturation = parseInt(document.getElementById(`${colorType}-saturation`).value);
                const value = parseInt(document.getElementById(`${colorType}-value`).value);

                if (colorType === 'cold') {
                    coldColor = { h: hue, s: saturation, v: value };
                } else {
                    hotColor = { h: hue, s: saturation, v: value };
                }

                const hsl = hsvToHsl(hue, saturation, value);
                const rgb = hslToRgb(hsl.h, hsl.s, hsl.l);
                const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
                document.getElementById(`${colorType}-hex-display`).textContent = hex;

                renderVisualization(currentMode);
            }

            // Add event listeners for cold color sliders
            document.getElementById('cold-hue').addEventListener('input', () => updateColor('cold'));
            document.getElementById('cold-saturation').addEventListener('input', () => updateColor('cold'));
            document.getElementById('cold-value').addEventListener('input', () => updateColor('cold'));

            // Add event listeners for hot color sliders
            document.getElementById('hot-hue').addEventListener('input', () => updateColor('hot'));
            document.getElementById('hot-saturation').addEventListener('input', () => updateColor('hot'));
            document.getElementById('hot-value').addEventListener('input', () => updateColor('hot'));

            // Initial update of hex displays
            updateColor('cold');
            updateColor('hot');

            renderVisualization('anomaly'); // Initial render
        });
    </script>
</body>
</html>
